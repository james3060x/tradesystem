<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
	<title>âœ¨äº¤æ˜“æ‰§è¡Œç³»ç»Ÿï½œç©ºä»“ä¼˜å…ˆ Pro MAXï¼ˆä¼˜åŒ–ç‰ˆï¼‰</title>

	<meta name="theme-color" content="#0f172a" />
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
	<meta name="apple-mobile-web-app-title" content="äº¤æ˜“æ‰§è¡Œ Pro" />

	<!-- PWA Manifestï¼ˆå†…åµŒï¼‰ -->
	<link rel="manifest" href="data:application/manifest+json;base64,eyJuYW1lIjoi5Lqk5pOY5omn6KGM57O757ufIFBybyBNQVggKOaWueadvykiLCJzaG9ydF9uYW1lIjoi5Lqk5pOYIFBybyIsInN0YXJ0X3VybCI6Ii4vIiwic2NvcGUiOiIuLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwZjE3MmEiLCJ0aGVtZV9jb2xvciI6IiMwZjE3MmEiLCJpY29ucyI6W119" />

	<style>
	:root{
		--bg:#0f172a;--card:#1e293b;--text:#f1f5f9;--muted:#94a3b8;
		--border:#334155;--green:#22c55e;--yellow:#eab308;
		--red:#ef4444;--blue:#38bdf8;--orange:#fb923c;
		--shadow: 0 10px 30px rgba(0,0,0,.25);
	}
	*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
	body{
		margin:0;font-family:-apple-system,BlinkMacSystemFont,"SF Pro","PingFang SC","Noto Sans SC",sans-serif;
		background:var(--bg);color:var(--text)
	}
	header{
		text-align:center;padding:16px 14px;font-weight:800;border-bottom:1px solid var(--border);
		position:sticky;top:0;background:rgba(15,23,42,.92);backdrop-filter: blur(10px);
		z-index:10;
	}
	.container{max-width:520px;margin:auto;padding:16px}
	.card{
		background:var(--card);border-radius:16px;padding:16px;margin-bottom:16px;
		box-shadow: var(--shadow);
		border: 1px solid rgba(51,65,85,.55);
	}
	h3{margin:0 0 12px;font-size:16px}
	hr{border:0;border-top:1px solid var(--border);margin:12px 0}
	button,input,select,textarea{
		width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);
		background:var(--bg);color:var(--text);font-size:16px;outline:none;
	}
	input::placeholder{color:#64748b}
	.row{display:flex;gap:10px}
	.row > *{flex:1}
	button{
		background:var(--blue);border:none;font-weight:800;margin-top:8px;
		cursor:pointer;
	}
	button:disabled{opacity:.5;cursor:not-allowed}
	button.secondary{background:transparent;border:1px solid var(--border);color:var(--text)}
	button.danger{background:var(--red)}
	button.warn{background:var(--orange)}
	label{display:flex;align-items:center;margin-bottom:10px;font-size:15px}
	input[type=checkbox]{width:20px;height:20px;margin-right:10px}

	.status{
		padding:16px;border-radius:12px;text-align:center;font-weight:900;font-size:20px;
		letter-spacing:.2px;
	}
	.green{color:var(--green);border:2px solid var(--green);background:rgba(34,197,94,.08)}
	.yellow{color:var(--yellow);border:2px solid var(--yellow);background:rgba(234,179,8,.08)}
	.red{color:var(--red);border:2px solid var(--red);background:rgba(239,68,68,.08)}
	.hint{font-size:13px;color:var(--muted);line-height:1.5}
	.center{text-align:center}
	.kpi{
		display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px
	}
	.kpi .box{
		background:rgba(15,23,42,.5);
		border:1px solid rgba(51,65,85,.6);
		border-radius:12px;padding:10px
	}
	.kpi .t{font-size:12px;color:var(--muted)}
	.kpi .v{font-size:16px;font-weight:800;margin-top:4px}
	.badge{
		display:inline-block;padding:6px 10px;border-radius:999px;
		border:1px solid var(--border);font-size:12px;color:var(--muted)
	}
	.list{font-size:14px}
	.list div{
		display:flex;justify-content:space-between;gap:10px;
		padding:10px 0;border-bottom:1px solid var(--border)
	}
	.win{color:var(--green);font-weight:800}
	.loss{color:var(--red);font-weight:800}
	.small{font-size:12px;color:var(--muted)}
	.pill{
		padding:2px 8px;border-radius:999px;border:1px solid var(--border);
		font-size:12px;color:var(--muted);white-space:nowrap
	}
	svg{width:100%;height:140px;display:block;margin-top:8px}
	.footerActions{display:flex;gap:10px;flex-wrap:wrap}
	.footerActions button{flex:1;min-width:150px}
	</style>
</head>

<body>
<header>ğŸ§  äº¤æ˜“æ‰§è¡Œç³»ç»Ÿ Â· ç©ºä»“ä¼˜å…ˆ Pro MAXï¼ˆä¼˜åŒ–ç‰ˆï¼‰</header>

<div class="container">

	<!-- ===== çŠ¶æ€ä»ªè¡¨ç›˜ ===== -->
	<div class="card">
		<h3>ğŸ“Š ç³»ç»ŸæŒ‡ä»¤</h3>
		<div id="status" class="status red">ğŸ›‘ é»˜è®¤ï¼šç©ºä»“</div>
		<div class="hint center" id="positionHint">ä»“ä½å»ºè®®ï¼š0%</div>

		<div class="kpi">
			<div class="box">
				<div class="t">è¿äºï¼ˆå½“å‰ï¼‰</div>
				<div class="v" id="kpiLossStreak">0</div>
			</div>
			<div class="box">
				<div class="t">é”ä»“çŠ¶æ€</div>
				<div class="v" id="kpiLock">å¦</div>
			</div>
			<div class="box">
				<div class="t">ç©ºä»“å¥–åŠ±ç‚¹</div>
				<div class="v" id="kpiReward">0</div>
			</div>
		</div>

		<div class="hint" style="margin-top:10px">
			<span class="badge" id="lockHint">é”ä»“è§„åˆ™ï¼šè¿ç»­äºæŸ â‰¥ <span id="cfgLockN">3</span> ç¬” â‡’ é”ä»“ <span id="cfgLockDays">1</span> å¤©</span>
		</div>
	</div>

	<!-- ===== å‚æ•°è®¾ç½® ===== -->
	<div class="card">
		<h3>âš™ï¸ å‚æ•°ï¼ˆä½ å¯è°ƒï¼‰</h3>
		<div class="row">
			<div>
				<div class="small">è¿ç»­äºæŸé”ä»“é˜ˆå€¼ï¼ˆç¬”ï¼‰</div>
				<input id="lockN" type="number" min="2" max="10" step="1" />
			</div>
			<div>
				<div class="small">é”ä»“å¤©æ•°ï¼ˆå¤©ï¼‰</div>
				<input id="lockDays" type="number" min="1" max="14" step="1" />
			</div>
		</div>
		<div class="row" style="margin-top:10px">
			<div>
				<div class="small">è½»ä»“å»ºè®®ï¼ˆ%ï¼‰</div>
				<input id="posLight" type="number" min="5" max="50" step="5" />
			</div>
			<div>
				<div class="small">ç»¿ç¯å»ºè®®ï¼ˆ%ï¼‰</div>
				<input id="posFull" type="number" min="50" max="100" step="5" />
			</div>
		</div>
		<button class="secondary" onclick="saveConfig()">ä¿å­˜å‚æ•°</button>
	</div>

	<!-- ===== 30ç§’æ£€æŸ¥ ===== -->
	<div class="card">
		<h3>âœ… 30 ç§’æ‰§è¡Œæ£€æŸ¥</h3>

		<label><input type="checkbox" class="rule">è¶‹åŠ¿ / ç»“æ„æˆç«‹</label>
		<label><input type="checkbox" class="rule">å…³é”®ä½ + ä¿¡å·</label>
		<label><input type="checkbox" class="rule">ç›ˆäºæ¯” â‰¥ 1:2</label>
		<label><input type="checkbox" class="rule">å¸‚åœºèŠ‚å¥åŒ¹é…</label>
		<label><input type="checkbox" class="rule">æƒ…ç»ªç¨³å®š</label>

		<hr>

		<label><input type="checkbox" id="emotion">âš ï¸ FOMO / å›æœ¬å¿ƒæ€</label>
		<label><input type="checkbox" id="violation">ğŸš« ç³»ç»Ÿå¤–äº¤æ˜“ï¼ˆä»»ä½•å€Ÿå£éƒ½ç®—ï¼‰</label>

		<button id="judgeBtn" onclick="judge()">æ‰§è¡Œç³»ç»Ÿåˆ¤å®š</button>
		<div class="hint" id="judgeHint" style="margin-top:10px"></div>
	</div>

	<!-- ===== è®°å½•äº¤æ˜“ ===== -->
	<div class="card">
		<h3>ğŸ’¾ è®°å½•äº¤æ˜“</h3>
		<div class="row">
			<input id="symbol" placeholder="æ ‡çš„ï¼ˆå¦‚ TSLA / BTC / RKLBï¼‰" />
			<input id="pnl" type="number" inputmode="decimal" placeholder="ç›ˆäºï¼ˆæ•°å­—ï¼‰" />
		</div>

		<div class="row" style="margin-top:10px">
			<select id="tradeType">
				<option value="trade">äº¤æ˜“</option>
				<option value="paper">æ¨¡æ‹Ÿ/è§‚å¯Ÿä»“</option>
				<option value="review">å¤ç›˜è®°å½•ï¼ˆä¸è®¡å…¥é”ä»“ï¼‰</option>
			</select>
			<select id="tag">
				<option value="">æ ‡ç­¾ï¼ˆå¯é€‰ï¼‰</option>
				<option value="A+">A+æœºä¼š</option>
				<option value="breakout">çªç ´</option>
				<option value="meanrevert">å‡å€¼å›å½’</option>
				<option value="event">äº‹ä»¶é©±åŠ¨</option>
			</select>
		</div>

		<button id="addBtn" onclick="addTrade()">ä¿å­˜</button>
		<div class="hint" id="addHint" style="margin-top:10px"></div>
	</div>

	<!-- ===== ç©ºä»“å¥–åŠ± ===== -->
	<div class="card">
		<h3>ğŸ† ç©ºä»“å¥–åŠ±ï¼ˆçºªå¾‹ç§¯åˆ†ï¼‰</h3>
		<div class="hint">
			è§„åˆ™ï¼šæ¯å¤©é¦–æ¬¡æ‰“å¼€ç³»ç»Ÿæ—¶ï¼Œå¦‚æœä½ å½“æ—¥æ²¡æœ‰æ–°å¢â€œäº¤æ˜“â€è®°å½•ï¼Œå°±ç®—â€œç©ºä»“æ—¥ +1â€ï¼Œå¥–åŠ±ç‚¹æ•° +1ã€‚<br>
			ä½ å¯ä»¥æŠŠå®ƒæ˜ å°„æˆã€Œä¸‹æ¬¡å…è®¸çš„è¯•é”™æ¬¡æ•°ã€æˆ–ã€Œæœ¬å‘¨å¯äº¤æ˜“æ¬¡æ•°ã€ã€‚
		</div>
		<div class="row" style="margin-top:10px">
			<button class="secondary" onclick="markNoTradeToday()">æ‰‹åŠ¨ç¡®è®¤ï¼šä»Šå¤©ç©ºä»“</button>
			<button class="danger" onclick="resetReward()">é‡ç½®å¥–åŠ±</button>
		</div>
	</div>

	<!-- ===== ä»ªè¡¨ç›˜ ===== -->
	<div class="card">
		<h3>ğŸ“ˆ ä»ªè¡¨ç›˜</h3>
		<div class="hint" id="stats"></div>
		<svg id="chart"></svg>
	</div>

	<!-- ===== åˆ—è¡¨ ===== -->
	<div class="card">
		<h3>ğŸ“œ æœ€è¿‘äº¤æ˜“</h3>
		<div class="list" id="list"></div>
		<div class="hint" id="listHint" style="margin-top:10px"></div>
	</div>

	<!-- ===== æ•°æ®ç®¡ç† ===== -->
	<div class="card">
		<h3>ğŸ§° æ•°æ®ç®¡ç†</h3>
		<div class="footerActions">
			<button class="secondary" onclick="exportData()">å¯¼å‡º JSON</button>
			<button class="secondary" onclick="importData()">å¯¼å…¥ JSON</button>
			<button class="warn" onclick="undoLast()">æ’¤é”€æœ€è¿‘ä¸€æ¡</button>
			<button class="danger" onclick="clearAll()">æ¸…ç©ºå…¨éƒ¨æ•°æ®</button>
		</div>
		<div class="hint" style="margin-top:10px">
			æç¤ºï¼šæ‰‹æœºæµè§ˆå™¨ localStorage å¯èƒ½è¢«ç³»ç»Ÿæ¸…ç†ã€‚å»ºè®®å®šæœŸå¯¼å‡ºå¤‡ä»½ã€‚
		</div>
	</div>

	<div class="hint center">
		ç‰ˆæœ¬ï¼šv2ï¼ˆä¼˜åŒ–ç‰ˆï¼‰ Â· æ ¸å¿ƒç†å¿µï¼šç³»ç»Ÿä¼˜å…ˆäºæ„Ÿè§‰
	</div>
</div>

<script>
/** =========================
 *  å­˜å‚¨ç»“æ„
 * =========================
 * state = {
 *   config: { lockN, lockDays, posLight, posFull },
 *   trades: [{sym,p,time,type,tag,lockedFlag, note}],
 *   lock: { untilTs }, // é”ä»“åˆ°æœŸæ—¶é—´æˆ³ï¼ˆæ¯«ç§’ï¼‰
 *   reward: { points, lastCheckDate, streakDays }
 * }
 */
const KEY = "TS_PRO_MAX_V2";

const DEFAULT_STATE = {
	config: {
		lockN: 3,
		lockDays: 1,
		posLight: 25,
		posFull: 100
	},
	trades: [],
	lock: { untilTs: 0 },
	reward: { points: 0, lastCheckDate: "", streakDays: 0 }
};

function todayStr(){
	const d = new Date();
	const y = d.getFullYear();
	const m = String(d.getMonth()+1).padStart(2,"0");
	const day = String(d.getDate()).padStart(2,"0");
	return `${y}-${m}-${day}`;
}

function loadState(){
	try{
		const raw = localStorage.getItem(KEY);
		if(!raw) return structuredClone(DEFAULT_STATE);
		const obj = JSON.parse(raw);
		return mergeDeep(structuredClone(DEFAULT_STATE), obj);
	}catch(e){
		return structuredClone(DEFAULT_STATE);
	}
}

function saveState(state){
	localStorage.setItem(KEY, JSON.stringify(state));
	render();
}

function mergeDeep(base, incoming){
	for(const k in incoming){
		if(incoming[k] && typeof incoming[k] === "object" && !Array.isArray(incoming[k])){
			base[k] = mergeDeep(base[k] || {}, incoming[k]);
		}else{
			base[k] = incoming[k];
		}
	}
	return base;
}

function isLocked(state){
	return Date.now() < (state.lock?.untilTs || 0);
}

function setLockDays(state, days){
	const now = Date.now();
	const until = now + days * 24 * 60 * 60 * 1000;
	state.lock.untilTs = Math.max(state.lock.untilTs || 0, until);
}

function getLossStreak(state){
	// è¿äºï¼šä»æœ€è¿‘ä¸€ç¬”å¼€å§‹å¾€ä¸‹æ•°ï¼Œç›´åˆ°é‡åˆ°éäºæŸæˆ–é‡åˆ°ä¸è®¡å…¥é”ä»“çš„è®°å½•
	let streak = 0;
	for(const x of state.trades){
		if(x.type === "review") continue;         // å¤ç›˜ä¸è®¡å…¥é”ä»“
		if(typeof x.p !== "number") continue;
		if(x.p < 0){ streak++; }
		else break;
	}
	return streak;
}

function computeStats(state){
	const t = state.trades;
	let total=0, win=0, loss=0, count=0;
	for(const x of t){
		if(x.type === "review") continue; // å¤ç›˜ä¸è®¡å…¥ç»Ÿè®¡ï¼ˆä½ ä¹Ÿå¯ä»¥æ”¹æˆè®¡å…¥ï¼‰
		if(typeof x.p !== "number") continue;
		count++;
		total += x.p;
		if(x.p > 0) win++;
		if(x.p < 0) loss++;
	}
	const winRate = count ? Math.round(win / count * 100) : 0;
	return { total, win, loss, count, winRate };
}

/** =========================
 *  UI å¼•ç”¨
 * ========================= */
const statusEl = document.getElementById("status");
const positionHintEl = document.getElementById("positionHint");
const statsEl = document.getElementById("stats");
const listEl = document.getElementById("list");
const chartEl = document.getElementById("chart");
const judgeHintEl = document.getElementById("judgeHint");
const addHintEl = document.getElementById("addHint");

const kpiLossStreakEl = document.getElementById("kpiLossStreak");
const kpiLockEl = document.getElementById("kpiLock");
const kpiRewardEl = document.getElementById("kpiReward");

const lockNInput = document.getElementById("lockN");
const lockDaysInput = document.getElementById("lockDays");
const posLightInput = document.getElementById("posLight");
const posFullInput = document.getElementById("posFull");
const cfgLockNEl = document.getElementById("cfgLockN");
const cfgLockDaysEl = document.getElementById("cfgLockDays");
const lockHintEl = document.getElementById("lockHint");

const judgeBtn = document.getElementById("judgeBtn");
const addBtn = document.getElementById("addBtn");

/** =========================
 *  ä¸šåŠ¡é€»è¾‘
 * ========================= */
function saveConfig(){
	const state = loadState();
	const lockN = clampInt(lockNInput.value, 2, 10, DEFAULT_STATE.config.lockN);
	const lockDays = clampInt(lockDaysInput.value, 1, 14, DEFAULT_STATE.config.lockDays);
	const posLight = clampInt(posLightInput.value, 5, 50, DEFAULT_STATE.config.posLight);
	const posFull = clampInt(posFullInput.value, 50, 100, DEFAULT_STATE.config.posFull);

	state.config = { lockN, lockDays, posLight, posFull };
	saveState(state);
	alert("å‚æ•°å·²ä¿å­˜");
}

function clampInt(v, min, max, fallback){
	const n = parseInt(v, 10);
	if(Number.isNaN(n)) return fallback;
	return Math.min(max, Math.max(min, n));
}

function judge(){
	const state = loadState();
	const locked = isLocked(state);
	const lossStreak = getLossStreak(state);

	const rules = [...document.querySelectorAll(".rule")].filter(r => r.checked).length;
	const emo = document.getElementById("emotion").checked;
	const vio = document.getElementById("violation").checked;

	let s="red", txt="ğŸ›‘ å¿…é¡»ç©ºä»“", pos="0%";
	let hint = "";

	// æœ€é«˜ä¼˜å…ˆçº§ï¼šè¿è§„ => ç›´æ¥é”ä»“ï¼ˆå¹¶å»¶é•¿é”ä»“ï¼‰
	if(vio){
		s="red";
		txt="ğŸš« è¿è§„ï¼šç«‹åˆ»é”ä»“";
		pos="0%";
		setLockDays(state, state.config.lockDays);
		hint = `å·²è§¦å‘é”ä»“ï¼ˆ${state.config.lockDays}å¤©ï¼‰ã€‚ç³»ç»Ÿå¤–äº¤æ˜“=ç³»ç»Ÿæ‹’ç»ã€‚`;
		saveState(state);
	}
	// ç¬¬äºŒä¼˜å…ˆçº§ï¼šé”ä»“æœŸ
	else if(locked || lossStreak >= state.config.lockN){
		// å¦‚æœåªæ˜¯â€œè¾¾åˆ°è¿äºé˜ˆå€¼ä½†è¿˜æ²¡è®¾ç½®é”ä»“â€ï¼Œè¿™é‡Œè¡¥ä¸€æ¬¡é”ä»“
		if(!locked && lossStreak >= state.config.lockN){
			setLockDays(state, state.config.lockDays);
			saveState(state);
		}
		s="red";
		txt="â›” é”ä»“æœŸï¼šç¦æ­¢å¼€ä»“";
		pos="0%";
		const until = new Date(loadState().lock.untilTs);
		hint = `é”ä»“åˆ°æœŸï¼š${formatTime(until)}ã€‚è¿äº(${lossStreak}) â‰¥ é˜ˆå€¼(${state.config.lockN}) æ—¶ç³»ç»Ÿå¼ºåˆ¶ä¼‘æ¯ã€‚`;
	}
	// ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼šæƒ…ç»ªæœŸ
	else if(emo){
		s="yellow";
		txt="âš ï¸ æƒ…ç»ªæœŸï¼šåªå…è®¸è½»ä»“æˆ–æ¨¡æ‹Ÿ";
		pos = `${state.config.posLight}%`;
		hint = "å»ºè®®ï¼šåªåšè§‚å¯Ÿä»“/æ¨¡æ‹Ÿï¼Œæˆ–è€…ä»Šå¤©ç›´æ¥ç©ºä»“ã€‚";
	}
	// è§„åˆ™æ»¡è¶³æƒ…å†µ
	else if(rules === 5){
		s="green";
		txt="ğŸš€ å…è®¸æ‰§è¡Œ";
		pos = `${state.config.posFull}%`;
		hint = "å…è®¸æ‰§è¡Œ â‰  å¿…é¡»äº¤æ˜“ã€‚åªåšæœ€åƒçš„é‚£ä¸€ç¬”ã€‚";
	}else if(rules >= 3){
		s="yellow";
		txt="âš–ï¸ è½»ä»“è¯•é”™";
		pos = `${state.config.posLight}%`;
		hint = "åªå…è®¸è¯•é”™ä»“ã€‚ä»»ä½•åŠ ä»“å¿…é¡»é‡æ–°åˆ¤å®šä¸€æ¬¡ã€‚";
	}else{
		s="red";
		txt="ğŸ›‘ æ¡ä»¶ä¸è¶³ï¼šç©ºä»“";
		pos = "0%";
		hint = "ç©ºä»“ä¹Ÿæ˜¯äº¤æ˜“çš„ä¸€éƒ¨åˆ†ã€‚";
	}

	statusEl.className = `status ${s}`;
	statusEl.innerText = txt;
	positionHintEl.innerText = "ä»“ä½å»ºè®®ï¼š" + pos;
	judgeHintEl.innerText = hint;

	window.scrollTo({top:0, behavior:"smooth"});
	render();
}

function addTrade(){
	const state = loadState();
	const locked = isLocked(state);

	const sym = document.getElementById("symbol").value.trim();
	const p = parseFloat(document.getElementById("pnl").value);
	const type = document.getElementById("tradeType").value;
	const tag = document.getElementById("tag").value;

	addHintEl.innerText = "";

	if(!sym || Number.isNaN(p)){
		alert("è¯·å¡«å†™å®Œæ•´ï¼šæ ‡çš„ + ç›ˆäºæ•°å­—");
		return;
	}

	// é”ä»“æœŸï¼šç¦æ­¢è®°å½•â€œäº¤æ˜“â€ï¼ˆä½ ä»å¯è®°å½•æ¨¡æ‹Ÿ/å¤ç›˜ï¼‰
	if(locked && type === "trade"){
		alert("å½“å‰å¤„äºé”ä»“æœŸï¼šç¦æ­¢æ–°å¢â€œäº¤æ˜“â€è®°å½•ã€‚ä½ å¯ä»¥æ”¹æˆâ€œæ¨¡æ‹Ÿ/è§‚å¯Ÿä»“â€æˆ–â€œå¤ç›˜è®°å½•â€ã€‚");
		return;
	}

	state.trades.unshift({
		sym,
		p,
		time: Date.now(),
		type,
		tag,
		lockedFlag: locked ? 1 : 0
	});

	// è®°å½•åï¼Œæ£€æŸ¥æ˜¯å¦è§¦å‘è¿äºé”ä»“
	if(type !== "review"){
		const lossStreak = getLossStreak(state);
		if(lossStreak >= state.config.lockN){
			setLockDays(state, state.config.lockDays);
		}
	}

	// æ¸…ç©ºè¾“å…¥
	document.getElementById("symbol").value = "";
	document.getElementById("pnl").value = "";

	saveState(state);
	addHintEl.innerText = locked ? "å·²è®°å½•ï¼ˆé”ä»“æœŸæ ‡è®°ï¼‰ã€‚" : "å·²ä¿å­˜ã€‚";
}

function formatTime(d){
	const y=d.getFullYear();
	const m=String(d.getMonth()+1).padStart(2,"0");
	const day=String(d.getDate()).padStart(2,"0");
	const hh=String(d.getHours()).padStart(2,"0");
	const mm=String(d.getMinutes()).padStart(2,"0");
	return `${y}-${m}-${day} ${hh}:${mm}`;
}

/** =========================
 *  ç©ºä»“å¥–åŠ±æœºåˆ¶
 * ========================= */
function autoNoTradeCheck(){
	const state = loadState();
	const today = todayStr();

	// å·²å¤„ç†è¿‡ä»Šå¤©å°±ä¸é‡å¤
	if(state.reward.lastCheckDate === today) return;

	// å¦‚æœä»Šå¤©æ²¡æœ‰ä»»ä½•â€œäº¤æ˜“â€è®°å½•ï¼Œåˆ™ç©ºä»“æ—¥ +1
	const hasTradeToday = state.trades.some(x => {
		if(x.type !== "trade") return false;
		const d = new Date(x.time);
		return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}` === today;
	});

	if(!hasTradeToday){
		state.reward.points += 1;
		state.reward.streakDays += 1;
	}else{
		state.reward.streakDays = 0;
	}

	state.reward.lastCheckDate = today;
	saveState(state);
}

function markNoTradeToday(){
	const state = loadState();
	const today = todayStr();

	// é˜²é‡å¤
	if(state.reward.lastCheckDate === today){
		alert("ä»Šå¤©å·²ç»ç»“ç®—è¿‡äº†ã€‚");
		return;
	}

	state.reward.points += 1;
	state.reward.streakDays += 1;
	state.reward.lastCheckDate = today;
	saveState(state);
	alert("å·²ç¡®è®¤ï¼šä»Šå¤©ç©ºä»“ +1 å¥–åŠ±ç‚¹ã€‚");
}

function resetReward(){
	const ok = confirm("ç¡®è®¤é‡ç½®ç©ºä»“å¥–åŠ±ç‚¹æ•°ï¼Ÿ");
	if(!ok) return;
	const state = loadState();
	state.reward = { points: 0, lastCheckDate: "", streakDays: 0 };
	saveState(state);
}

/** =========================
 *  æ•°æ®ç®¡ç†
 * ========================= */
function exportData(){
	const state = loadState();
	const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
	const url = URL.createObjectURL(blob);
	const a = document.createElement("a");
	a.href = url;
	a.download = `TS_PRO_MAX_backup_${todayStr()}.json`;
	a.click();
	URL.revokeObjectURL(url);
}

function importData(){
	const input = document.createElement("input");
	input.type = "file";
	input.accept = "application/json";
	input.onchange = async () => {
		const file = input.files[0];
		if(!file) return;
		try{
			const text = await file.text();
			const obj = JSON.parse(text);
			const merged = mergeDeep(structuredClone(DEFAULT_STATE), obj);
			localStorage.setItem(KEY, JSON.stringify(merged));
			render();
			alert("å¯¼å…¥æˆåŠŸ");
		}catch(e){
			alert("å¯¼å…¥å¤±è´¥ï¼šJSON æ ¼å¼ä¸æ­£ç¡®");
		}
	};
	input.click();
}

function undoLast(){
	const state = loadState();
	if(!state.trades.length){
		alert("æ²¡æœ‰å¯æ’¤é”€çš„è®°å½•");
		return;
	}
	const ok = confirm(`ç¡®è®¤æ’¤é”€æœ€è¿‘ä¸€æ¡ï¼š${state.trades[0].sym} / ${state.trades[0].p} ï¼Ÿ`);
	if(!ok) return;
	state.trades.shift();
	saveState(state);
}

function clearAll(){
	const ok = confirm("ç¡®è®¤æ¸…ç©ºå…¨éƒ¨æ•°æ®ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼ˆå»ºè®®å…ˆå¯¼å‡ºï¼‰ã€‚");
	if(!ok) return;
	localStorage.removeItem(KEY);
	render();
}

/** =========================
 *  æ¸²æŸ“
 * ========================= */
function render(){
	const state = loadState();
	autoNoTradeCheck(); // æ¯æ¬¡æ¸²æŸ“éƒ½å°è¯•åšä¸€æ¬¡â€œå½“æ—¥ç»“ç®—â€ï¼ˆæœ‰é˜²é‡å¤ï¼‰

	// é…ç½®å›å¡«
	lockNInput.value = state.config.lockN;
	lockDaysInput.value = state.config.lockDays;
	posLightInput.value = state.config.posLight;
	posFullInput.value = state.config.posFull;

	cfgLockNEl.innerText = state.config.lockN;
	cfgLockDaysEl.innerText = state.config.lockDays;

	// KPI
	const lossStreak = getLossStreak(state);
	const locked = isLocked(state);
	kpiLossStreakEl.innerText = String(lossStreak);
	kpiLockEl.innerText = locked ? "æ˜¯" : "å¦";
	kpiRewardEl.innerText = String(state.reward.points);

	// å¦‚æœé”ä»“ï¼šå¼ºåˆ¶çŠ¶æ€æ˜¾ç¤ºï¼ˆé™¤éä½ åˆšæ‰‹åŠ¨ judgeï¼‰
	if(locked){
		const until = new Date(state.lock.untilTs);
		lockHintEl.innerText = `å½“å‰é”ä»“åˆ°æœŸï¼š${formatTime(until)}ï¼ˆè¿äºé˜ˆå€¼ ${state.config.lockN}ï¼Œé”ä»“ ${state.config.lockDays} å¤©ï¼‰`;
		judgeBtn.disabled = false;
		addBtn.disabled = false; // addTrade å†…éƒ¨ä¼šæ‹¦æˆª type=trade
	}else{
		lockHintEl.innerText = `é”ä»“è§„åˆ™ï¼šè¿ç»­äºæŸ â‰¥ ${state.config.lockN} ç¬” â‡’ é”ä»“ ${state.config.lockDays} å¤©`;
		judgeBtn.disabled = false;
		addBtn.disabled = false;
	}

	// Stats
	const {total, win, loss, count, winRate} = computeStats(state);
	let lockMsg = "";
	if(locked){
		lockMsg = " â›” é”ä»“ä¸­";
	}
	statsEl.innerText = `è®°å½•:${state.trades.length}ï¼ˆç»Ÿè®¡å£å¾„:${count}ï¼‰ èƒœç‡:${winRate}% ç´¯è®¡:${total.toFixed(2)}${lockMsg}  ç©ºä»“è¿èƒœ:${state.reward.streakDays}å¤©`;

	// List
	const t = state.trades;
	listEl.innerHTML = t.slice(0,10).map(x => {
		const d = new Date(x.time);
		const time = `${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")} ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
		const cls = x.p >= 0 ? "win" : "loss";
		const typeLabel = x.type === "trade" ? "äº¤æ˜“" : (x.type === "paper" ? "æ¨¡æ‹Ÿ" : "å¤ç›˜");
		const tag = x.tag ? `<span class="pill">${escapeHtml(x.tag)}</span>` : `<span class="pill">${typeLabel}</span>`;
		const lockFlag = x.lockedFlag ? `<span class="pill">é”ä»“æœŸ</span>` : "";
		return `
			<div>
				<span>
					<strong>${escapeHtml(x.sym)}</strong>
					<span class="small"> ${time}</span>
					<br>${tag} ${lockFlag}
				</span>
				<span class="${cls}">${x.p}</span>
			</div>
		`;
	}).join("");

	document.getElementById("listHint").innerText =
		"æç¤ºï¼šå¤ç›˜è®°å½•ä¸ä¼šè§¦å‘é”ä»“ï¼›é”ä»“æœŸç¦æ­¢æ–°å¢â€œäº¤æ˜“â€ï¼Œä½†å…è®¸è®°å½•æ¨¡æ‹Ÿ/å¤ç›˜ã€‚";

	drawChart(state);
}

function escapeHtml(s){
	return String(s).replace(/[&<>"']/g, m => ({
		"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
	}[m]));
}

function drawChart(state){
	const t = state.trades.filter(x => x.type !== "review"); // å›¾è¡¨ä¸å«å¤ç›˜
	chartEl.innerHTML = "";
	if(t.length < 2) return;

	let cum = 0;
	const arr = [0];
	t.slice().reverse().forEach(x => { cum += x.p; arr.push(cum); });

	const w = chartEl.clientWidth || 320;
	const h = 140;

	const max = Math.max(...arr);
	const min = Math.min(...arr);
	const span = (max - min) || 1;

	let pts = "";
	arr.forEach((v, i) => {
		const x = i/(arr.length-1)*w;
		const y = h - ((v - min)/span)*h;
		pts += `${x},${y} `;
	});

	const stroke = "#38bdf8";
	chartEl.innerHTML = `
		<polyline fill="none" stroke="${stroke}" stroke-width="2.5" points="${pts.trim()}" />
		<line x1="0" y1="${h - ((0 - min)/span)*h}" x2="${w}" y2="${h - ((0 - min)/span)*h}" stroke="rgba(148,163,184,.35)" stroke-width="1" />
	`;
}

/** =========================
 *  PWA Service Worker
 * ========================= */
async function registerSW(){
	if(!("serviceWorker" in navigator)) return;
	try{
		await navigator.serviceWorker.register("./sw.js", { scope: "./" });
	}catch(e){
		// å¦‚æœä½ åªæ”¾äº† index.html æ²¡æ”¾ sw.jsï¼Œå°±ä¼šå¤±è´¥ï¼Œä½†ä¸å½±å“ä½¿ç”¨
	}
}

registerSW();
render();
</script>
</body>
</html>